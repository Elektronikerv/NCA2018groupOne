office.findById=SELECT id, name, address_id, description FROM offices WHERE id=:id
office.deleteById=DELETE FROM offices WHERE id=:id
office.update=UPDATE offices SET (name, address_id, description) = \
   (:name, :address_id, :description)  WHERE id=:id

office.insert.withAddress= \
WITH data(name, description ,street , house, floor, flat) AS (\
    VALUES  (:name, :description, :street, :house, :floor, :flat) ,
address_insert AS (\
    INSERT INTO addresses(street, house, floor, flat) \
    SELECT street, house, floor, flat \
    FROM data \
    ON     CONFLICT DO NOTHING  \
    RETURNING street, house, floor, flat, id AS address_id \
    )\
INSERT INTO offices (name , description, address_id)\
SELECT name, description, address_id \
FROM data \
JOIN address_insert USING (street, house, floor, flat) 

office.find.withAddress = \
  SELECT o.id , o.name, o.description, \
  a.id  AS address_id, a.street ,a.house ,a.floor ,a.flat \
  FROM offices AS o \
  JOIN addresses AS a ON o.address_id = a.id

office.findByName.withAddress = \
  SELECT o.id , o.name, o.description, \
  a.id AS address_id, a.street, a.house, a.floor, a.flat \
  FROM offices AS o \
  JOIN addresses AS a ON o.address_id = a.id \
  WHERE o.name LIKE '%'||:name||'%' \
  ORDER BY o.name ASC \

office.findByStreet.withAddress = \
  SELECT o.id, o.name, o.description,\
  a.id AS address_id, a.street, a.house, a.floor, a.flat \
  FROM offices AS o \
  JOIN addresses AS a ON o.address_id = a.id \
  WHERE a.street LIKE '%'||:street||'%' \
  ORDER BY a.street ASC


site_information_type.findById=SELECT id, name FROM site_information_types WHERE id=:id
site_information_type.deleteById=DELETE FROM site_information_types WHERE id=:id
site_information_type.update=UPDATE site_information_types SET name = :name WHERE id=:id

siteInformation.findById=SELECT id, text, admin_id, type_id FROM site_information WHERE id=:id
siteInformation.deleteById=DELETE FROM site_information WHERE id=:id
siteInformation.update=UPDATE site_information SET (text, admin_id, type_id) = (:text, :admin_id, :type_id)  WHERE id=:id



user.findByEmail=SELECT id, password, first_name, last_name, phone_number, email, manager_id, address_id, registration_date FROM users WHERE email=:email
user.findById=SELECT id, password, first_name, last_name, phone_number, email, manager_id, address_id, registration_date FROM users WHERE id=:id
user.deleteByEmail=DELETE FROM users WHERE email=:email
user.deleteById=DELETE FROM users WHERE id=:id
user.update=UPDATE users SET (password, first_name, last_name, phone_number, email, manager_id, address_id, registration_date) = \
(:password, :first_name, :last_name, :phone_number, :email, :manager_id, :address_id, :registration_date)  WHERE id=:id

user.findEmployees = \
  SELECT emp.id, emp.first_name, emp.last_name, emp.email, \
  emp.phone_number, emp.address_id, emp.manager_id, \
  mgr.first_name AS manager_name, \
  r.name AS position, a.street , a.house, a.floor, a.flat \
  FROM users AS emp \
  LEFT JOIN addresses AS a ON emp.address_id = a.id \
  JOIN users_roles AS u_r ON emp.id = u_r.user_id \
  JOIN roles AS r ON u_r.role_id = r.id \
  LEFT JOIN users AS mgr ON emp.manager_id = mgr.id \
  WHERE r.name = 'admin' \
  OR r.name = 'ccagent' \
  OR r.name ='manager' \
  OR r.name ='courier' \
  ORDER BY emp.first_name \

user.findEmployeesByLastName = \
  SELECT emp.id, emp.first_name, emp.last_name, emp.email, \
  emp.phone_number, emp.address_id, emp.manager_id, \
  mgr.first_name AS manager_name, \
  r.name AS position, a.street , a.house, a.floor, a.flat \
  FROM users AS emp \
  LEFT JOIN addresses AS a ON emp.address_id = a.id \
  JOIN users_roles AS u_r ON emp.id = u_r.user_id \
  JOIN roles AS r ON u_r.role_id = r.id \
  LEFT JOIN users AS mgr ON emp.manager_id = mgr.id \
  WHERE r.name = 'admin' \
  OR r.name = 'ccagent' \
  OR r.name ='manager' \
  OR r.name ='courier' \
  WHERE emp.last_name LIKE '%'||:last_name||'%' \
  ORDER BY emp.last_name ASC

user.findEmployeesByManager = \
  SELECT emp.id, emp.first_name, emp.last_name, emp.email, \
  emp.phone_number, emp.address_id, emp.manager_id, \
  mgr.first_name AS manager_name, \
  r.name AS position, a.street , a.house, a.floor, a.flat \
  FROM users AS emp \
  LEFT JOIN addresses AS a ON emp.address_id = a.id \
  JOIN users_roles AS u_r ON emp.id = u_r.user_id \
  JOIN roles AS r ON u_r.role_id = r.id \
  LEFT JOIN users AS mgr ON emp.manager_id = mgr.id \
  WHERE r.name = 'admin' \
  OR r.name = 'ccagent' \
  OR r.name ='manager' \
  OR r.name ='courier' \
  WHERE mgr.id = :id \
  ORDER BY emp.last_name ASC

user.createEmployee = \
  WITH data(email, password, first_name, last_name,\
   phone_number, registration_date, manager_id, \
  street , house, floor, flat) AS (\
  VALUES  (:email, :password, :first_name,\
  :last_name, :phone_number, :registration_date, :manager_id, \
  :street, :house, :floor, :flat)) ,\
  address_insert AS ( \
  INSERT INTO addresses(street, house, floor, flat) \
  SELECT street, house, floor, flat FROM data \
  ON     CONFLICT DO NOTHING \
  RETURNING street, house, floor, flat, id AS address_id)\
  INSERT INTO users (email, password, first_name, last_name, phone_number,\
  registration_date , manager_id, address_id)\
  SELECT email, password, first_name, last_name, phone_number,\
  registration_date,  manager_id, address_id\
  FROM data\
  JOIN address_insert USING (street, house, floor, flat) ;

user.updateEmployee= \
  WITH data1(name, description ,street , house, floor, flat) AS ( \
  VALUES  (:name, :description , :street , :house, :floor, :flat)), \
  data AS ( \
  UPDATE addresses AS a \
  SET (street, house, floor, flat) = (street, house, floor, flat) \
  WHERE a.id = :address_id \
  RETURNING a.id AS addr_id) \
  UPDATE users AS emp \
  SET (email, password, first_name, last_name, phone_number, \
  registration_date , manager_id, address_id) = \
  (:email, :password, :first_name, :last_name, :phone_number, \
  :registration_date , :manager_id, addr_id) \
  FROM data \
  WHERE emp.id=:id

  

address.findById=SELECT id, street, house, floor, flat FROM addresses WHERE id=:id
address.deleteById=DELETE FROM addresses WHERE id=:id
address.update=UPDATE addresses SET (street, house, floor, flat) = \
   (:street, :house, :floor, :flat)  WHERE id=:id

service.findById=SELECT id, order_id, ccagent_id, courier_id, confirmation_time, shipping_time, attempt FROM services WHERE id=:id
service.deleteById=DELETE FROM services WHERE id=:id
service.update=UPDATE services SET (order_id, ccagent_id, courier_id, confirmation_time, shipping_time, attempt) = \
   (:order_id, :ccagent_id, :courier_id, :confirmation_time, :shipping_time, :attempt)  WHERE id=:id

order.findById=SELECT  id, user_id,  office_id, order_status_id, receiver_address_id, sender_address_id, description, feedback, creation_time, execution_time, parent_id  FROM orders WHERE id=:id
order.deleteById=DELETE FROM orders WHERE id=:id
order.update=UPDATE orders SET (user_id, office_id, order_status_id, receiver_address_id, sender_address_id, description, feedback, creation_time, execution_time) = (:user_id, :office_id, :order_status_id, :receiver_address_id, :sender_address_id, :description, feedback, :creation_time, :execution_time)  WHERE id=:id

working_day.findById=SELECT id, user_id, workday_end, workday_start, worked_out FROM working_days WHERE id=:id
working_day.deleteById=DELETE FROM working_days WHERE id=:id
working_day.update=UPDATE working_days SET (user_id, workday_end, workday_start, worked_out) = (:user_id, :workday_start, :workday_start, :worked_out)  WHERE id=:id

order_status.findById=SELECT id, name, description FROM order_status WHERE id=:id
order_status.deleteById=DELETE FROM order_status WHERE id=:id
order_status.update=UPDATE order_status SET (name, description) = \
   (:name, :description)  WHERE id=:id

role.findById=SELECT id, name, description FROM roles WHERE id=:id
role.deleteById=DELETE FROM roles WHERE id=:id
role.update=UPDATE roles SET (name, description) = (:name, :description)  WHERE id=:id
role.findByUserId=SELECT role_id FROM users_roles WHERE user_id = :user_id
